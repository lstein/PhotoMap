<!DOCTYPE html>
<html>
  <head>
    <title id="slideshow_title">Slideshow</title>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=10, user-scalable=yes"
    />
    <link rel="icon" type="image/x-icon" href="static/favicon.ico" />
    <link
      rel="apple-touch-icon"
      sizes="180x180"
      href="static/apple-touch-icon.png"
    />
    <link rel="stylesheet" type="text/css" href="static/slides.css" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script
      src="https://cdn.plot.ly/plotly-3.0.1.min.js"
      charset="utf-8"
    ></script>
    <script>
      // Pass server data to JavaScript
      window.slideshowConfig = {
          currentDelay: {{ delay }},
          mode: "{{ mode }}",
          album: {% if album %}"{{ album }}"{% else %}null{% endif %},
          setupMode: {{ setup_mode|lower }}
      };

      {% if setup_mode %}
      // Trigger the "no albums found" event to open album manager
      document.addEventListener('DOMContentLoaded', function() {
        window.dispatchEvent(new CustomEvent('noAlbumsFound'));
      });
      {% endif %}
    </script>
    <script type="module" src="static/main.js"></script>
  </head>

  <body>
    <!-- Fixed score display -->
    <div id="fixedScoreDisplay" class="fixed-score-display hidden">
      <span id="scoreText">score=0.000</span>
    </div>

    <div class="swiper">
      <div class="swiper-wrapper" id="carousel-wrapper">
        <!-- Slides will be added dynamically -->
      </div>
      <div class="swiper-scrollbar"></div>
    </div>

    <!-- Combined Banner and Drawer Container -->
    <div id="bannerDrawerContainer" class="banner-drawer-container">
      <!-- Overlay Drawer Toggle -->
      <div id="overlayDrawer" class="overlay-drawer">
        <div class="drawer-handle">
          <svg class="drawer-arrow" viewBox="0 0 18 18">
            <path d="M7 14l5-5 5 5z" fill="currentColor" />
          </svg>
        </div>
      </div>

      <!-- File Info Banner -->
      <div id="filenameBanner" class="filename-banner">
        <div class="filenameDescContainer">
          <div class="filenameRow">
            <span id="filenameText"></span>
            <button id="copyTextBtn" title="Copy text">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path
                  d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"
                />
              </svg>
            </button>
          </div>
          <div id="descriptionText"></div>
          <div id="filepathText"></div>
        </div>
      </div>
    </div>

    <div id="spinner">
      <svg width="60" height="60" viewBox="0 0 50 50">
        <circle
          cx="25"
          cy="25"
          r="20"
          fill="none"
          stroke="#888"
          stroke-width="5"
          stroke-linecap="round"
          stroke-dasharray="31.4 31.4"
          transform="rotate(-90 25 25)"
        >
          <animateTransform
            attributeName="transform"
            type="rotate"
            from="0 25 25"
            to="360 25 25"
            dur="1s"
            repeatCount="indefinite"
          />
        </circle>
      </svg>
    </div>

    <div id="swiperPrevBtnGroup">
      <div class="swiper-button-prev"></div>
    </div>
    <div id="swiperNextBtnGroup">
      <div class="swiper-button-next"></div>
    </div>

    <div id="bottomLeftBtnGroup">
      <!-- Settings (gear) button, far left -->
      <button id="settingsBtn" title="Settings">
        <svg
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="#fff"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <circle cx="12" cy="12" r="3" />
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 9 3.09V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"
          />
        </svg>
      </button>

      <button id="deleteCurrentFileBtn" title="Delete image">
        <svg
          width="28"
          height="28"
          viewBox="0 0 24 24"
          fill="none"
          stroke="#fff"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <polyline points="3 6 5 6 21 6" />
          <path
            d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2"
          />
          <line x1="10" y1="11" x2="10" y2="17" />
          <line x1="14" y1="11" x2="14" y2="17" />
        </svg>
      </button>

      <button id="fullscreenBtn" title="Fullscreen">
        <svg width="48" height="48" viewBox="0 0 24 24" fill="#fff">
          <path
            d="M4 4h6V2H2v8h2V4zm16 0v6h2V2h-8v2h6zm0 16h-6v2h8v-8h-2v6zM4 20v-6H2v8h8v-2H4z"
          />
        </svg>
      </button>

      <button id="startStopSlideshowBtn" title="Start/Pause Slideshow">
        <span id="slideshowIcon">
          <svg
            id="playIcon"
            width="32"
            height="32"
            viewBox="0 0 24 24"
            fill="#fff"
          >
            <polygon points="5,3 19,12 5,21" />
          </svg>
          <svg
            id="pauseIcon"
            width="32"
            height="32"
            viewBox="0 0 24 24"
            fill="#fff"
          >
            <rect x="6" y="4" width="4" height="16" />
            <rect x="14" y="4" width="4" height="16" />
          </svg>
        </span>
      </button>
    </div>

    <div id="searchPanel">
      <div class="search-panel-title">Search</div>
      <div class="search-icons-row">
        <div class="search-icon-container">
          <button id="showUmapBtn" title="Show UMAP">
            <span id="showUmapIcon">
              <svg
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#fff"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <!-- Outer circle -->
                <circle cx="12" cy="12" r="9" />
                <!-- Center dot -->
                <circle cx="12" cy="12" r="2.2" fill="#fff" />
                <!-- Rays -->
                <line x1="12" y1="0" x2="12" y2="7" />
                <line x1="12" y1="17" x2="12" y2="24" />
                <line x1="0" y1="12" x2="7" y2="12" />
                <line x1="17" y1="12" x2="24" y2="12" />
              </svg>
            </span>
          </button>
          <div class="button-label">By Map</div>
        </div>

        <div class="search-icon-container">
          <button id="imageSearchBtn" title="Search for similar images">
            <span id="imageSearchIcon">
              <svg
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#fff"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21 15 16 10 5 21" />
              </svg>
            </span>
          </button>
          <div class="button-label">By Image</div>
        </div>

        <div class="search-icon-container">
          <button id="textSearchBtn" title="Search">
            <span id="textSearchIcon">
              <svg
                id="searchIcon"
                width="32"
                height="32"
                viewBox="0 0 24 24"
                fill="none"
                stroke="#fff"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <circle cx="11" cy="11" r="8" />
                <line x1="21" y1="21" x2="16.65" y2="16.65" />
              </svg>
            </span>
          </button>
          <div class="button-label">By Text</div>
        </div>

        <div class="clear-search-container">
          <button
            id="clearSearchBtn"
            title="Clear Search"
            style="display: none"
          >
            <svg
              width="32"
              height="32"
              viewBox="0 0 24 24"
              fill="none"
              stroke="#fff"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <rect x="4" y="4" width="16" height="16" rx="2" ry="2" />
              <line x1="8" y1="8" x2="16" y2="16" />
              <line x1="16" y1="8" x2="8" y2="16" />
            </svg>
          </button>
          <div class="button-label">Clear</div>
        </div>
      </div>
    </div>

    <div id="textSearchPanel">
      <div class="search-controls">
        <div class="search-input-container">
          <input
            id="searchInput"
            type="text"
            placeholder="Search..."
            autocomplete="off"
          />
          <button id="clearTextSearchBtn" title="Clear search">&#10005;</button>
        </div>
        <button id="doSearchBtn">Search</button>
      </div>
      <span style="color: white; font-size: 80%"
        >Or paste, drag or
        <a
          href="#"
          id="uploadImageLink"
          class="upload-link"
          style="font-size: inherit"
          >upload</a
        >
        <input
          type="file"
          id="uploadImageInput"
          accept="image/*"
          style="display: none"
        />
        a search image.</span
      >
    </div>

    <!-- UMAP Floating Window -->
    <div id="umapFloatingWindow">
      <!-- Titlebar -->
      <div id="umapTitlebar">
        <span>Semantic Map</span>
        <div style="display: flex; align-items: center; gap: 8px">
          <!-- Resizing icons -->
          <button id="umapResizeFullscreen" title="Fullscreen" class="icon-btn">
            <svg width="24" height="24" viewBox="0 0 24 24">
              <rect
                x="2"
                y="2"
                width="20"
                height="20"
                rx="4"
                fill="#fff"
                opacity="0.8"
              />
              <polyline
                points="4,4 20,4 20,20 4,20 4,4"
                stroke="#888"
                stroke-width="2"
                fill="none"
              />
            </svg>
          </button>

          <button id="umapResizeBig" title="Large" class="icon-btn">
            <svg width="28" height="28" viewBox="0 0 28 28">
              <rect
                x="4"
                y="4"
                width="20"
                height="20"
                rx="4"
                fill="#fff"
                opacity="0.8"
              />
            </svg>
          </button>
          <button id="umapResizeMedium" title="Medium" class="icon-btn">
            <svg width="20" height="20" viewBox="0 0 20 20">
              <rect
                x="3"
                y="3"
                width="14"
                height="14"
                rx="3"
                fill="#fff"
                opacity="0.8"
              />
            </svg>
          </button>
          <button id="umapResizeShaded" title="Shaded" class="icon-btn">
            <svg width="14" height="14" viewBox="0 0 14 14">
              <rect
                x="2"
                y="2"
                width="10"
                height="6"
                rx="2"
                fill="#fff"
                opacity="0.8"
              />
            </svg>
          </button>
          <button
            id="umapCloseBtn"
            style="
              background: none;
              border: none;
              color: #fff;
              font-size: 1.5em;
              cursor: pointer;
              margin-left: 8px;
            "
            title="Close"
          >
            &times;
          </button>
        </div>
      </div>
      <!-- Spinner (always visible during loading) -->
      <div
        id="umapSpinner"
        style="
          display: none;
          position: absolute;
          left: 50%;
          top: 50%;
          transform: translate(-50%, -50%);
          z-index: 1000;
        "
      >
        <div class="umap-spinner"></div>
      </div>

      <!-- All other content hidden until plot is ready -->
      <div id="umapContent" style="display: none">
        <!-- Plotly Plot -->
        <div id="umapPlot"></div>

        <!-- Controls Row: EPS spinner and Color Mode -->
        <div
          style="
            display: flex;
            flex-direction: row;
            gap: 24px;
            justify-content: center;
            align-items: flex-start;
            margin-top: 12px;
          "
        >
          <!-- EPS Spinner Container -->
          <div id="umapEpsContainer" style="display: none; padding: 8px">
            <label for="umapEpsSpinner">Cluster Strength</label>
            <input
              type="number"
              id="umapEpsSpinner"
              min="0.01"
              max="0.5"
              step="0.01"
              value="0.07"
              style="width: 60px"
            />
          </div>

          <!-- Colorization Mode Controls (vertical column) -->
          <div
            id="umapColorModeContainer"
            style="display: flex; flex-direction: column; margin-bottom: 12px"
          >
            <label style="color: #eee; font-weight: bold; margin-bottom: 6px"
              >Color by</label
            >
            <div
              style="
                display: flex;
                flex-direction: row;
                gap: 16px;
                justify-content: flex-start;
              "
            >
              <label>
                <input
                  type="radio"
                  name="umapColorMode"
                  id="umapColorClusters"
                  value="cluster"
                  checked
                />
                Clusters
              </label>
              <label>
                <input
                  type="radio"
                  name="umapColorMode"
                  id="umapColorSearch"
                  value="search"
                />
                Search
              </label>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Settings Overlay -->
    <div id="settingsOverlay" class="modal-overlay">
      <div class="modal-content settings-modal">
        <button
          id="closeSettingsBtn"
          class="modal-close"
          title="Close settings"
        >
          ✖
        </button>

        <div class="settings-header">
          <span id="slideshowSettingsLabel">Slideshow Settings</span>
        </div>

        <div class="settings-main">
          <!-- Left column: Slower/Faster/Interval -->
          <div class="delay-controls">
            <div id="delayLabel">Slide Change Interval</div>

            <div class="delay-control-buttons">
              <button id="fasterBtn" title="Faster">&#9664;</button>
              <span id="delayValue">10</span>
              <button id="slowerBtn" title="Slower">&#9654;</button>
            </div>
          </div>

          <!-- Right column: Mode controls -->
          <div id="modeControls">
            <div id="modeLabel">Slide Browse Order:</div>

            <div id="modeRadioGroup">
              <label
                ><input
                  type="radio"
                  id="modeRandom"
                  name="mode"
                  value="random"
                  checked
                />
                Random</label
              >
              <label
                ><input
                  type="radio"
                  id="modeSequential"
                  name="mode"
                  value="sequential"
                />
                Sequential</label
              >
            </div>
          </div>
        </div>

        <!-- Settings rows -->
        <div class="setting-row">
          <label for="highWaterMarkInput">Max Slides in History:</label>
          <input
            id="highWaterMarkInput"
            type="number"
            min="2"
            max="100"
            value="10"
          />
        </div>

        <!-- Input for the LocationIQ API Key -->
        <div class="setting-row">
          <label for="locationiqApiKeyInput"
            >LocationIQ API Key (for maps):</label
          >
          <form style="display: inline; margin: 0">
            <input
              type="password"
              id="locationiqApiKeyInput"
              placeholder="Enter your LocationIQ API key (optional)"
              autocomplete="pk-xxxxxxxx"
              style="
                width: 100%;
                padding: 8px;
                border: 1px solid #ccc;
                border-radius: 4px;
              "
            />
            <small
              style="
                color: #666;
                font-size: 0.85em;
                display: block;
                margin-top: 4px;
              "
            >
              Optional: Enables location names and maps in EXIF data.
              <a
                href="https://locationiq.com"
                target="_blank"
                style="color: #007bff"
                >Get a free key</a
              >
            </small>
          </form>
        </div>

        <div class="setting-row">
          <label for="albumSelect">Album:</label>
          <div class="album-selector-group">
            <select id="albumSelect">
              <option value="">Loading albums...</option>
            </select>
            <button id="manageAlbumsBtn" class="btn-primary">
              Manage Albums
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Album Management Overlay -->
    <div id="albumManagementOverlay" class="modal-overlay album-management">
      <div class="modal-content album-management-modal">
        <!-- Header with Add Album Button (fixed) -->
        <div class="album-header">
          <h2>Album Management</h2>
          <div class="header-buttons">
            <button id="showAddAlbumBtn" class="btn-primary">
              + Add Album
            </button>
            <button
              id="closeAlbumManagementBtn"
              class="modal-close"
              title="Close"
            >
              ✖
            </button>
          </div>
        </div>

        <!-- Add New Album Section (fixed, if desired) -->
        <div id="addAlbumSection" class="add-album-section">
          <div class="section-header">
            <h3>Add New Album</h3>
            <button id="cancelAddAlbumBtn" class="cancel-btn" title="Cancel">
              ✖
            </button>
          </div>

          <div class="form-grid">
            <div class="form-group">
              <label>Album Key</label>
              <input
                id="newAlbumKey"
                type="text"
                placeholder="e.g., vacation_2024"
              />
            </div>
            <div class="form-group">
              <label>Display Name</label>
              <input
                id="newAlbumName"
                type="text"
                placeholder="e.g., Vacation 2024"
              />
            </div>
          </div>

          <div class="form-group">
            <label>Description</label>
            <input
              id="newAlbumDescription"
              type="text"
              placeholder="Optional description"
            />
          </div>

          <div class="form-group">
            <label>Image Paths (one per line)</label>
            <textarea
              id="newAlbumPaths"
              placeholder="/path/to/images&#10;/another/path/to/images"
              rows="3"
            ></textarea>
          </div>

          <div class="form-buttons">
            <button id="addAlbumBtn" class="btn-primary">Add Album</button>
            <button id="cancelAddAlbumBtn2" class="btn-secondary">
              Cancel
            </button>
          </div>
        </div>

        <!-- Scrollable Albums Section -->
        <div
          id="albumsScrollContainer"
          style="max-height: 60vh; overflow-y: auto"
        >
          <div id="existingAlbumsSection">
            <h3>Albums</h3>
            <div id="albumsList">
              <!-- Albums will be populated here -->
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Album Card Template -->
    <template id="albumCardTemplate">
      <div class="album-card">
        <!-- Album Info Section -->
        <div class="album-info">
          <div class="album-details">
            <!-- Left side - Album details -->
            <div class="album-text">
              <h4 class="album-name"></h4>
              <div class="album-key"></div>
              <div class="album-description"></div>
              <div class="album-paths"></div>
            </div>

            <!-- Right side - Index controls -->
            <div class="indexing-section">
              <!-- Index Status and Button -->
              <div class="index-controls">
                <div class="index-status">Ready to index</div>
                <button class="create-index-btn btn-index">Update Index</button>
                <button class="cancel-index-btn btn-cancel">Cancel</button>
              </div>

              <!-- Progress Container -->
              <div class="progress-container">
                <div class="progress-bar-wrapper">
                  <div class="progress-bar-track">
                    <div class="progress-bar"></div>
                    <div class="progress-bar-shimmer"></div>
                  </div>
                  <div class="progress-text">0%</div>
                </div>
                <div class="estimated-time"></div>
              </div>
            </div>
          </div>

          <!-- Action Buttons Row -->
          <div class="action-buttons">
            <button class="edit-album-btn btn-edit">Edit</button>
            <button class="delete-album-btn btn-delete">Delete</button>
          </div>
        </div>

        <!-- Edit Form -->
        <div class="edit-form">
          <h5>Edit Album</h5>
          <div class="form-grid">
            <div class="form-group">
              <label>Display Name</label>
              <input class="edit-album-name" type="text" />
            </div>
            <div class="form-group">
              <label>Description</label>
              <input class="edit-album-description" type="text" />
            </div>
          </div>

          <div class="form-group">
            <label>Image Paths (one per line)</label>
            <textarea class="edit-album-paths" rows="3"></textarea>
          </div>

          <div class="form-buttons">
            <button class="save-album-btn btn-primary">Save Changes</button>
            <button class="cancel-edit-btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </template>
  </body>
</html>
