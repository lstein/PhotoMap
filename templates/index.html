<!DOCTYPE html>
<html>

<head>
    <title>CLIP Image Search</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        input[type="number"] {
            color: #fff;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Image Search</h1>
        <form id="upload-form" method="post" enctype="multipart/form-data">
            <div id="upload-area" class="upload-area"
                style="display: flex; align-items: center; gap: 16px; padding: 12px 16px;">
                <label for="file" class="upload-label" style="margin-bottom: 0; cursor: pointer; white-space: nowrap;">
                    Click to select or drag an image here.
                    <br>
                    <span class="upload-note">
                        You can also paste an image directly.<br>Click on the thumbnail to repeat the search.
                    </span>
                </label>
                <input type="file" id="file" name="file" accept="image/*"
                    style="opacity:0;position:absolute;left:-9999px;">
                <div id="preview"
                    style="margin-top: 0; position: relative; width: 80px; height: 80px; background: #000; overflow: hidden; display: flex; align-items: flex-start; justify-content: center;">
                    {% if uploaded_image_url %}
                    <img src="{{ uploaded_image_url }}" id="preview-img"
                        style="max-width:100%; max-height:100%; display:block; border-radius:8px; box-shadow:0 1px 6px #0006; cursor:pointer;"
                        title="Click to search with this image">
                    <button type="button" id="clear-preview" title="Clear image">&#10005;</button>
                    {% endif %}
                </div>

                <div
                    style="display: flex; flex-direction: column; gap: 8px; margin-left: 8px; color: #ccc; font-size: 0.95em; min-width: 140px;">
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        Top K:
                        <input type="number" id="top_k" name="top_k" min="1" max="50"
                            value="{{ top_k if top_k is defined else 9 }}"
                            style="width: 60px; margin-left: 4px; background: transparent; border: 1px solid #444; border-radius: 4px; color: #fff; text-align: right;">
                    </label>
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        Minimum Score:
                        <input type="number" id="cosine_cutoff" name="cosine_cutoff" min="0" max="1" step="0.01"
                            value="{{ cosine_cutoff if cosine_cutoff is defined else 0.6 }}"
                            style="width: 70px; margin-left: 4px; background: transparent; border: 1px solid #444; border-radius: 4px; color: #fff; text-align: right;">
                    </label>
                </div>
            </div>
            <label for="text_query" style="margin-bottom: 0; color: #ccc; font-size: 0.95em;">
                Or search by text:
                <input type="text" id="text_query" name="text_query" placeholder="Describe what you're looking for"
                    value="{{ text_query if text_query is defined else '' }}"
                    style="width: 260px; margin-left: 8px; background: transparent; border: 1px solid #444; border-radius: 4px; color: #fff; padding: 4px;">
            </label>
            <!-- <input type="hidden" name="embeddings_file" value="clip_image_embeddings.npz"> -->
        </form>
        {% if results is defined %}
        {% if results %}
        <h2>
            Top {{ results|length }} Match{{ 'es' if results|length != 1 else '' }}
        </h2>
        <div class="results-scroll">
            <div class="grid">
                {% for img in results %}
                <div class="tile" style="position: relative;">
                    <img src="{{ img.filename }}" alt="Match">
                    <div class="score">Score: {{ img.score }}</div>
                    <button class="search-this" data-src="{{ img.filename }}" title="Search with this image"
                        style="
            position: absolute;
            right: 6px;
            bottom: 6px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: #222c;
            color: #fff;
            font-size: 1.2em;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.85;
            z-index: 2;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 4px #0006;
        ">?</button>
                </div>
                {% endfor %}
            </div>
        </div>
        {% else %}
        {% if request.method == 'POST' %}
        <div class="results-scroll" style="text-align:center; color:#ffb86c; font-size:1.2em; padding:32px;">
            No matches found for your query.
        </div>
        {% endif %}
        {% endif %}
        {% endif %}
    </div>
    <div id="spinner"
        style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#23272acc; z-index:9999; align-items:center; justify-content:center;">
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div
                style="border:8px solid #444; border-top:8px solid #ffb86c; border-radius:50%; width:64px; height:64px; animation:spin 1s linear infinite;">
            </div>
            <div style="color:#fff; margin-top:18px; font-size:1.2em;">Searching...</div>
        </div>
    </div>
    <div id="popup-preview" style="
    display: none;
    position: fixed;
    z-index: 10000;
    pointer-events: none;
    border: 2px solid #444;
    background: #111;
    padding: 8px;
    border-radius: 8px;
    box-shadow: 0 4px 32px #000a;
    max-width: 800px;
    max-height: 800px;
">
        <img id="popup-preview-img" src="" style="max-width: 800px; max-height: 800px; display: block; border-radius: 6px;">
    </div>
    <script>
        const uploadForm = document.getElementById('upload-form');
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file');
        const preview = document.getElementById('preview');
        const spinner = document.getElementById('spinner');
        const topKInput = document.getElementById('top_k');
        const cosineCutoffInput = document.getElementById('cosine_cutoff');

        // --- Persist top_k and cosine_cutoff values in localStorage ---
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('top_k')) {
                topKInput.value = localStorage.getItem('top_k');
            }
            if (localStorage.getItem('cosine_cutoff')) {
                cosineCutoffInput.value = localStorage.getItem('cosine_cutoff');
            }
        });

        topKInput.addEventListener('change', () => {
            localStorage.setItem('top_k', topKInput.value);
        });
        cosineCutoffInput.addEventListener('change', () => {
            localStorage.setItem('cosine_cutoff', cosineCutoffInput.value);
        });

        uploadForm.addEventListener('submit', function () {
            spinner.style.display = 'flex';
        });

        // Restore thumbnail from localStorage if present and no file selected
        document.addEventListener('DOMContentLoaded', () => {
            if (!fileInput.files.length && !document.getElementById('preview-img') && localStorage.getItem('queryImage')) {
                const dataUrl = localStorage.getItem('queryImage');
                preview.innerHTML = `<img src="${dataUrl}" id="preview-img" style="max-width:80px;max-height:80px;border-radius:8px;box-shadow:0 1px 6px #0006; cursor: pointer;" title="Click to search with this image">`;
                document.getElementById('preview-img').onclick = () => {
                    fetch(dataUrl)
                        .then(res => res.blob())
                        .then(blob => {
                            const file = new File([blob], "query.jpg", { type: blob.type });
                            submitImageSearch(file);
                        });
                };
            }
            // Add click handler to server-rendered thumbnail
            const previewImg = document.getElementById('preview-img');
            if (previewImg) {
                previewImg.onclick = () => {
                    if (fileInput.files.length) {
                        document.getElementById('text_query').value = ''; // Clear text field
                        spinner.style.display = 'flex';
                        uploadForm.submit();
                    } else {
                        const dataUrl = localStorage.getItem('queryImage');
                        if (dataUrl) {
                            fetch(dataUrl)
                                .then(res => res.blob())
                                .then(blob => {
                                    const file = new File([blob], "query.jpg", { type: blob.type });
                                    submitImageSearch(file);
                                });
                        } else {
                            fileInput.click();
                        }
                    }
                };
            }
        });

        uploadArea.addEventListener('click', (e) => {
            if (e.target === uploadArea) {
                fileInput.click();
            }
        });
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                showThumbnail(e.dataTransfer.files[0]);
                document.getElementById('text_query').value = ''; // Clear text field
                spinner.style.display = 'flex';
                uploadForm.submit();
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                showThumbnail(fileInput.files[0]);
                document.getElementById('text_query').value = ''; // Clear text field
                spinner.style.display = 'flex';
                uploadForm.submit();
            }
        });

        document.addEventListener('paste', (e) => {
            const items = (e.clipboardData || window.clipboardData).items;
            for (let i = 0; i < items.length; i++) {
                if (items[i].type.indexOf('image') !== -1) {
                    const file = items[i].getAsFile();
                    if (file) {
                        submitImageSearch(file);
                    }
                    e.preventDefault();
                    break;
                }
            }
        });

        function showThumbnail(file) {
            if (!file.type.startsWith('image/')) {
                preview.innerHTML = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                const dataUrl = e.target.result;
                preview.innerHTML = `<img src="${dataUrl}" id="preview-img" style="max-width:80px;max-height:80px;border-radius:8px;box-shadow:0 1px 6px #0006; cursor: pointer;" title="Click to search with this image">`;
                localStorage.setItem('queryImage', dataUrl);
                document.getElementById('preview-img').onclick = () => {
                    spinner.style.display = 'flex';
                    uploadForm.submit();
                };
            };
            reader.readAsDataURL(file);
        }

        // Clear preview image and localStorage
        document.getElementById('clear-preview')?.addEventListener('click', () => {
            preview.innerHTML = '';
            fileInput.files = new DataTransfer().files;
            localStorage.removeItem('queryImage');
        });
        // Clear preview on page load if no image is selected
        document.addEventListener('DOMContentLoaded', () => {
            const clearBtn = document.getElementById('clear-preview');
            if (clearBtn) {
                clearBtn.onclick = function () {
                    preview.innerHTML = '';
                    localStorage.removeItem('queryImage');
                    fileInput.value = '';
                };
            }
        });

        // Trigger text search on Enter key in the text_query field
        document.getElementById('text_query')?.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form double-submit
                spinner.style.display = 'flex';
                preview.innerHTML = '';
                localStorage.removeItem('queryImage');
                fileInput.value = '';
                uploadForm.submit();
            }
        });

        // --- Popup preview on tile hover with delay ---
        const popup = document.getElementById('popup-preview');
        const popupImg = document.getElementById('popup-preview-img');
        let popupTimer = null;
        let lastMouseMove = 0;
        let mouseX = 0;
        let mouseY = 0;

        document.querySelectorAll('.tile img').forEach(img => {
            let hoverActive = false;

            img.addEventListener('mouseenter', function (e) {
                hoverActive = true;
                lastMouseMove = Date.now();
                mouseX = e.clientX;
                mouseY = e.clientY;

                function onMove(moveEvent) {
                    lastMouseMove = Date.now();
                    mouseX = moveEvent.clientX;
                    mouseY = moveEvent.clientY;
                }
                img.addEventListener('mousemove', onMove);

                // Start a timer to show the popup after 0.5 seconds of no movement
                popupTimer = setInterval(() => {
                    if (hoverActive && Date.now() - lastMouseMove > 500) {
                        popupImg.src = img.src;
                        popup.style.display = 'block';
                        // Force layout to get correct dimensions
                        popup.style.left = '-9999px';
                        popup.style.top = '-9999px';
                        setTimeout(() => {
                            document.onmousemove = function (moveEvent) {
                                let x = moveEvent.clientX + 24;
                                let y = moveEvent.clientY + 24;
                                const pad = 16;
                                const w = popup.offsetWidth;
                                const h = popup.offsetHeight;
                                if (x + w > window.innerWidth - pad) x = window.innerWidth - w - pad;
                                if (y + h > window.innerHeight - pad) y = window.innerHeight - h - pad;
                                popup.style.left = x + 'px';
                                popup.style.top = y + 'px';
                            };
                            // Immediately position at last known mouse location
                            let x = mouseX + 24;
                            let y = mouseY + 24;
                            const pad = 16;
                            const w = popup.offsetWidth;
                            const h = popup.offsetHeight;
                            if (x + w > window.innerWidth - pad) x = window.innerWidth - w - pad;
                            if (y + h > window.innerHeight - pad) y = window.innerHeight - h - pad;
                            popup.style.left = x + 'px';
                            popup.style.top = y + 'px';
                        }, 0);
                        clearInterval(popupTimer);
                        popupTimer = null;
                        img.removeEventListener('mousemove', onMove);
                    }
                }, 100);
            });

            img.addEventListener('mouseleave', function () {
                hoverActive = false;
                popup.style.display = 'none';
                popupImg.src = '';
                document.onmousemove = null;
                if (popupTimer) {
                    clearInterval(popupTimer);
                    popupTimer = null;
                }
                img.removeEventListener('mousemove', null);
            });
        });

        // Hide popup preview on mousedown and drag events
        document.addEventListener('mousedown', () => {
            popup.style.display = 'none';
            popupImg.src = '';
            document.onmousemove = null;
            if (popupTimer) {
                clearInterval(popupTimer);
                popupTimer = null;
            }
        });
        document.addEventListener('dragstart', () => {
            popup.style.display = 'none';
            popupImg.src = '';
            document.onmousemove = null;
            if (popupTimer) {
                clearInterval(popupTimer);
                popupTimer = null;
            }
        });

        // "Search with this image" button for each tile (works on iPad and desktop)
        document.querySelectorAll('.search-this').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                const imgUrl = btn.dataset.src;
                fetch(imgUrl)
                    .then(res => res.blob())
                    .then(blob => {
                        const file = new File([blob], "query.jpg", { type: blob.type });
                        submitImageSearch(file);
                    });
            });
        });

        function submitImageSearch(file) {
            const dt = new DataTransfer();
            dt.items.add(file);
            fileInput.files = dt.files;
            showThumbnail(file);
            document.getElementById('text_query').value = ''; // Clear text field
            spinner.style.display = 'flex';
            uploadForm.submit();
        }
    </script>
</body>

</html>