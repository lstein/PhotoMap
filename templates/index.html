<!DOCTYPE html>
<html>

<head>
    <title>CLIP Image Search</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        input[type="number"] {
            color: #fff;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>CLIP Image Search</h1>
        <form id="upload-form" method="post" enctype="multipart/form-data">
            <div id="upload-area" class="upload-area"
                style="display: flex; align-items: center; gap: 16px; padding: 12px 16px;">
                <label for="file" class="upload-label" style="margin-bottom: 0; cursor: pointer; white-space: nowrap;">
                    Click to select or drag an image here
                </label>
                <input type="file" id="file" name="file" accept="image/*" required
                    style="opacity:0;position:absolute;left:-9999px;">
                <div id="preview" style="margin-top: 0;">
                    {% if uploaded_image_url %}
                    <img src="{{ uploaded_image_url }}" id="preview-img"
                        style="max-width:80px;max-height:80px;border-radius:8px;box-shadow:0 1px 6px #0006; cursor: pointer;"
                        title="Click to search with this image">
                    {% endif %}
                </div>

                <div
                    style="display: flex; flex-direction: column; gap: 8px; margin-left: 8px; color: #ccc; font-size: 0.95em; min-width: 140px;">
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        Top K:
                        <input type="number" id="top_k" name="top_k" min="1" max="50"
                            value="{{ top_k if top_k is defined else 9 }}"
                            style="width: 60px; margin-left: 4px; background: transparent; border: 1px solid #444; border-radius: 4px; color: #fff; text-align: right;">
                    </label>
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        Cosine Cutoff:
                        <input type="number" id="cosine_cutoff" name="cosine_cutoff" min="0" max="1" step="0.01"
                            value="{{ cosine_cutoff if cosine_cutoff is defined else 0.6 }}"
                            style="width: 70px; margin-left: 4px; background: transparent; border: 1px solid #444; border-radius: 4px; color: #fff; text-align: right;">
                    </label>
                </div>
            </div>
            <input type="hidden" name="embeddings_file" value="clip_image_embeddings.npz">
        </form>
        {% if results %}
        <h2>Top 9 Matches</h2>
        <div class="results-scroll">
            <div class="grid">
                {% for img in results %}
                <div class="tile">
                    <img src="{{ img.filename }}" alt="Match">
                    <div class="score">Score: {{ img.score }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
    <div id="spinner"
        style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:#23272acc; z-index:9999; align-items:center; justify-content:center;">
        <div style="display:flex; flex-direction:column; align-items:center;">
            <div
                style="border:8px solid #444; border-top:8px solid #ffb86c; border-radius:50%; width:64px; height:64px; animation:spin 1s linear infinite;">
            </div>
            <div style="color:#fff; margin-top:18px; font-size:1.2em;">Searching...</div>
        </div>
    </div>
    <script>
        const uploadForm = document.getElementById('upload-form');
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file');
        const preview = document.getElementById('preview');
        const spinner = document.getElementById('spinner');

        // Show spinner on form submit
        uploadForm.addEventListener('submit', function () {
            spinner.style.display = 'flex';
        });

        // Restore thumbnail from localStorage if present and no file selected
        document.addEventListener('DOMContentLoaded', () => {
            if (!fileInput.files.length && !document.getElementById('preview-img') && localStorage.getItem('queryImage')) {
                const dataUrl = localStorage.getItem('queryImage');
                preview.innerHTML = `<img src="${dataUrl}" id="preview-img" style="max-width:80px;max-height:80px;border-radius:8px;box-shadow:0 1px 6px #0006; cursor: pointer;" title="Click to search with this image">`;
                document.getElementById('preview-img').onclick = () => {
                    fetch(dataUrl)
                        .then(res => res.blob())
                        .then(blob => {
                            const file = new File([blob], "query.jpg", { type: blob.type });
                            const dt = new DataTransfer();
                            dt.items.add(file);
                            fileInput.files = dt.files;
                            spinner.style.display = 'flex';
                            uploadForm.submit();
                        });
                };
            }
            // Add click handler to server-rendered thumbnail
            const previewImg = document.getElementById('preview-img');
            if (previewImg) {
                previewImg.onclick = () => {
                    if (fileInput.files.length) {
                        spinner.style.display = 'flex';
                        uploadForm.submit();
                    } else {
                        const dataUrl = localStorage.getItem('queryImage');
                        if (dataUrl) {
                            fetch(dataUrl)
                                .then(res => res.blob())
                                .then(blob => {
                                    const file = new File([blob], "query.jpg", { type: blob.type });
                                    const dt = new DataTransfer();
                                    dt.items.add(file);
                                    fileInput.files = dt.files;
                                    spinner.style.display = 'flex';
                                    uploadForm.submit();
                                });
                        } else {
                            fileInput.click();
                        }
                    }
                };
            }
        });

        uploadArea.addEventListener('click', (e) => {
            // Only trigger if the click is directly on the upload area, not on its children
            if (e.target === uploadArea) {
                fileInput.click();
            }
        });
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
        });
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                fileInput.files = e.dataTransfer.files;
                showThumbnail(e.dataTransfer.files[0]);
                spinner.style.display = 'flex';
                uploadForm.submit();
            }
        });
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                showThumbnail(fileInput.files[0]);
                spinner.style.display = 'flex';
                uploadForm.submit();
            }
        });

        function showThumbnail(file) {
            if (!file.type.startsWith('image/')) {
                preview.innerHTML = '';
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                const dataUrl = e.target.result;
                preview.innerHTML = `<img src="${dataUrl}" id="preview-img" style="max-width:80px;max-height:80px;border-radius:8px;box-shadow:0 1px 6px #0006; cursor: pointer;" title="Click to search with this image">`;
                // Save to localStorage
                localStorage.setItem('queryImage', dataUrl);
                // Add click handler to the new thumbnail
                document.getElementById('preview-img').onclick = () => {
                    spinner.style.display = 'flex';
                    uploadForm.submit();
                }
            };
            reader.readAsDataURL(file);
        }
    </script>
</body>

</html>